#!/usr/bin/env python

import sys
import optparse
import pybtex
from os import path

def main():
    opt_parser = optparse.OptionParser(prog='pybtex', usage='%prog auxfile[.aux] [options]', version='%%prog-%s' % pybtex.__version__)
    opt_parser.add_option('-o', '--output', action='store', type='string', dest='output')
    opt_parser.add_option('-f', '--bibliography-format', action='store', type='string', dest='bib_type', default='bibtex')
    opt_parser.add_option('--input-charset', action='store', type='string', dest='input_charset')
    (options, args) = opt_parser.parse_args()

    if not args:
        opt_parser.print_help()
        sys.exit(1)

    filename, ext = path.splitext(args[0])
    ext = ext.lstrip('.')

    bib_parser = pybtex.filters.find_filter('input', ext)
    aux_data = pybtex.auxfile.parse_file(filename + ".aux")
    bib_data = bib_parser.parse_file('%s.%s' % (aux_data.data, ext))
    
    entries = pybtex.prepare_entries(bib_data, aux_data)
    del bib_data
    #from formatters.latex import unsorted
    style = pybtex.import_style(aux_data.style)
    style.Formatter(entries).output_bibliography(filename + ".bbl")

if __name__ == '__main__':
    main()
